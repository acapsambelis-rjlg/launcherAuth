@model RJLG.LauncherAuthServer.Models.CustomerAccount
@{
    ViewBag.Title = Model.CustomerName;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var customerFiles = ViewBag.CustomerFiles as List<RJLG.LauncherAuthServer.Models.CustomerFile>;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="page-header mb-0"><i class="fas fa-building me-2"></i> @Model.CustomerName</h2>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-address-card me-2"></i> Contact Information
            </div>
            <div class="card-body">
                @using (Html.BeginForm("UpdateContact", "Customers", FormMethod.Post))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ID" value="@Model.ID" />
                    <div class="mb-3">
                        <label for="contactName" class="form-label">Contact Name</label>
                        <input type="text" class="form-control" id="contactName" name="ContactName" value="@Model.ContactName" />
                    </div>
                    <div class="mb-3">
                        <label for="contactEmail" class="form-label">Contact Email</label>
                        <input type="email" class="form-control" id="contactEmail" name="ContactEmail" value="@Model.ContactEmail" />
                    </div>
                    <div class="mb-3">
                        <label for="timezone" class="form-label">Timezone</label>
                        <input type="text" class="form-control" id="timezone" name="Timezone" value="@Model.Timezone" />
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="Notes" rows="3">@Model.Notes</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save Contact Info</button>
                }
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-box me-2"></i> Current Version
            </div>
            <div class="card-body">
                @using (Html.BeginForm("UpdateVersion", "Customers", FormMethod.Post, new { @class = "d-flex gap-2" }))
                {
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.ID" />
                    <select name="currentVersion" class="form-select" style="width: auto;">
                        @if (ViewBag.AvailableVersions != null)
                        {
                            foreach (RJLG.LauncherAuthServer.Models.IntelliSEMVersion version in ViewBag.AvailableVersions)
                            {
                                <option value="@version.Version" @(version.Version != null && version.Version.Equals(Model.CurrentVersion) ? "selected" : "")>@version.Version</option>
                            }
                        }
                    </select>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Update</button>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-key me-2"></i> Login Keys (@(Model.LoginKeys?.Count ?? 0))</span>
                <button id="showAddKeyModal" type="button" class="btn btn-sm btn-light"><i class="fas fa-plus me-1"></i> Add Key</button>
            </div>
            <div class="card-body p-0">
                @if (Model.LoginKeys != null && Model.LoginKeys.Count > 0)
                {
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Limit</th>
                                <th>Expiration</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var key in Model.LoginKeys)
                            {
                                var isExpired = key.Expiration.HasValue && key.Expiration.Value < DateTime.UtcNow;
                                var isExpiringSoon = key.Expiration.HasValue && !isExpired && key.Expiration.Value <= DateTime.UtcNow.AddDays(30);
                                <tr class="@(isExpired ? "table-secondary" : isExpiringSoon ? "table-warning" : "")">
                                    <td style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">@key.Key</td>
                                    <td>@(key.InstanceLimit?.ToString() ?? "-")</td>
                                    <td>
                                        @if (key.Expiration.HasValue)
                                        {
                                            @key.Expiration.Value.ToString("MMM dd, yyyy")
                                        }
                                        else
                                        {
                                            <span class="text-muted">Never</span>
                                        }
                                    </td>
                                    <td>
                                        @using (Html.BeginForm("Remove", "Keys", FormMethod.Post, new { style = "display:inline;" }))
                                        {
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="keyId" value="@key.ID" />
                                            <input type="hidden" name="customerId" value="@Model.ID" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this key?');"><i class="fas fa-trash"></i></button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="p-3 text-center text-muted">No keys assigned to this customer.</div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-folder me-2"></i> Files (@(customerFiles?.Count ?? 0))</span>
                <button id="showUploadFileModal" type="button" class="btn btn-sm btn-light"><i class="fas fa-upload me-1"></i> Upload File</button>
            </div>
            <div class="card-body p-0">
                @if (customerFiles != null && customerFiles.Count > 0)
                {
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Description</th>
                                <th>Size</th>
                                <th>Uploaded</th>
                                <th>By</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var file in customerFiles)
                            {
                                <tr>
                                    <td><i class="fas fa-file me-1"></i> @file.OriginalName</td>
                                    <td>@file.Description</td>
                                    <td>@file.GetFileSizeDisplay()</td>
                                    <td>@file.UploadedAt.ToString("MMM dd, yyyy")</td>
                                    <td>@file.UploadedBy</td>
                                    <td>
                                        <a href="@Url.Action("Download", "Files", new { id = file.ID })" class="btn btn-sm btn-outline-primary" title="Download"><i class="fas fa-download"></i></a>
                                        @using (Html.BeginForm("Delete", "Files", FormMethod.Post, new { style = "display:inline;" }))
                                        {
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@file.ID" />
                                            <input type="hidden" name="customerId" value="@Model.ID" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this file?');"><i class="fas fa-trash"></i></button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="p-3 text-center text-muted">No files uploaded for this customer.</div>
                }
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="@Url.Action("Index", "Customers")" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-1"></i> Back to Customers</a>
</div>

<div id="addKeyModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" type="button" id="closeAddKeyModal">&times;</button>
        <h5 class="mb-3">Add Login Key</h5>
        @using (Html.BeginForm("Save", "Keys", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            @Html.Partial("../Keys/_CreateKey")
            <input type="hidden" name="customerId" value="@Model.ID" />
        }
    </div>
</div>

<div id="uploadFileModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" type="button" id="closeUploadFileModal">&times;</button>
        <h5 class="mb-3">Upload File</h5>
        @using (Html.BeginForm("Upload", "Files", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {
            @Html.AntiForgeryToken()
            <input type="hidden" name="customerId" value="@Model.ID" />
            <div class="mb-3">
                <label for="file" class="form-label">Select File (max 50MB)</label>
                <input type="file" class="form-control" id="file" name="file" required />
            </div>
            <div class="mb-3">
                <label for="description" class="form-label">Description (optional)</label>
                <input type="text" class="form-control" id="description" name="description" maxlength="500" />
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-upload me-1"></i> Upload</button>
        }
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        position: relative;
    }
    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
    }
</style>

<script>
    document.getElementById('showAddKeyModal').onclick = function () {
        document.getElementById('addKeyModal').style.display = 'flex';
    };
    document.getElementById('closeAddKeyModal').onclick = function () {
        document.getElementById('addKeyModal').style.display = 'none';
    };
    document.getElementById('addKeyModal').onclick = function (e) {
        if (e.target === this) this.style.display = 'none';
    };
    
    document.getElementById('showUploadFileModal').onclick = function () {
        document.getElementById('uploadFileModal').style.display = 'flex';
    };
    document.getElementById('closeUploadFileModal').onclick = function () {
        document.getElementById('uploadFileModal').style.display = 'none';
    };
    document.getElementById('uploadFileModal').onclick = function (e) {
        if (e.target === this) this.style.display = 'none';
    };
</script>
